<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LYN Chatroom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Tetap pakai style neon dan led border kamu */
    body {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #0a0a0a;
      color: white;
    }
    .led-border {
      border: 2px solid #e63946;
      border-radius: 8px;
      overflow: hidden;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Login -->
  <div id="loginForm" class="p-6">
    <h2 class="text-xl mb-4">Join Chatroom</h2>
    <input id="nickname" placeholder="Nickname" class="mb-2 p-2 w-full text-black" />
    <input id="instagram" placeholder="Instagram" class="mb-2 p-2 w-full text-black" />
    <label class="block mb-2">
      <input type="checkbox" id="followCheck" /> I follow @exvisuites
    </label>
    <button id="joinChat" class="bg-red-600 px-4 py-2">Join Chat</button>
  </div>

  <!-- Chat -->
  <div id="chatInterface" class="hidden flex-1 flex flex-col p-4">
    <div class="flex justify-between mb-2">
      <span><i class="fas fa-users"></i> <span id="activeUserCount">0</span> online</span>
      <button id="leaveChat" class="text-red-400">Leave</button>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto mb-2 p-2 led-border"></div>
    <input id="messageInput" placeholder="Type a message..." class="p-2 text-black mb-2" />
    <button id="sendMessage" class="bg-yellow-500 px-4 py-2">Send</button>

    <h3 class="mt-4">Online Users</h3>
    <div id="userList" class="grid grid-cols-2 gap-2"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC7zwrxJVZPxEfM9ulVOUJOSCnMjb1kyk0",
      authDomain: "lynchat-f6fbc.firebaseapp.com",
      databaseURL: "https://lynchat-f6fbc-default-rtdb.firebaseio.com",
      projectId: "lynchat-f6fbc",
      storageBucket: "lynchat-f6fbc.appspot.com",
      messagingSenderId: "465251710149",
      appId: "1:465251710149:web:e6243a6ca5de6754c1ecac"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM
    const loginForm = document.getElementById('loginForm');
    const chatInterface = document.getElementById('chatInterface');
    const joinChatBtn = document.getElementById('joinChat');
    const leaveChatBtn = document.getElementById('leaveChat');
    const nicknameInput = document.getElementById('nickname');
    const instagramInput = document.getElementById('instagram');
    const followCheck = document.getElementById('followCheck');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessage');
    const messagesContainer = document.getElementById('messages');
    const userList = document.getElementById('userList');
    const activeUserCount = document.getElementById('activeUserCount');

    let currentUser = null;
    let userRef = null;
    let typingTimeout = null;

    joinChatBtn.addEventListener('click', async () => {
      const nickname = nicknameInput.value.trim();
      const instagram = instagramInput.value.trim();
      if (!nickname || nickname.length < 3) return alert('Invalid nickname');
      if (!instagram || instagram.length < 3) return alert('Invalid Instagram');
      if (!followCheck.checked) return alert('Please confirm follow');

      const id = generateId();
      userRef = db.ref(`users/${id}`);
      const userData = {
        nickname,
        instagram,
        color: getRandomColor(),
        typing: false,
        online: true,
        lastActive: Date.now()
      };

      await userRef.set(userData);
      userRef.onDisconnect().update({ online: false });
      currentUser = { id, ...userData };

      loginForm.classList.add('hidden');
      chatInterface.classList.remove('hidden');
      messageInput.focus();
    });

    leaveChatBtn.addEventListener('click', () => {
      if (!currentUser) return;
      if (!confirm('Leave chat?')) return;
      userRef.update({ online: false });
      userRef = null;
      currentUser = null;
      chatInterface.classList.add('hidden');
      loginForm.classList.remove('hidden');
      nicknameInput.value = '';
      instagramInput.value = '';
      followCheck.checked = false;
    });

    sendMessageBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });
    messageInput.addEventListener('input', () => {
      setTyping(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => setTyping(false), 1500);
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;

      db.ref('messages').push({
        text,
        userId: currentUser.id,
        nickname: currentUser.nickname,
        color: currentUser.color,
        timestamp: Date.now()
      });

      messageInput.value = '';
      setTyping(false);
    }

    function setTyping(status) {
      if (!userRef) return;
      userRef.update({ typing: status, lastActive: Date.now() });
    }

    db.ref('messages').on('child_added', snapshot => {
      const msg = snapshot.val();
      const msgEl = document.createElement('div');
      msgEl.innerHTML = `
        <div class="mb-2 p-2 ${msg.userId === (currentUser && currentUser.id) ? 'bg-red-700' : 'bg-gray-800'} rounded">
          <strong style="color:${msg.color}">${msg.nickname}</strong><br>
          ${msg.text}<br>
          <small class="text-gray-400">${formatTime(msg.timestamp)}</small>
        </div>
      `;
      messagesContainer.appendChild(msgEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });

    db.ref('users').on('value', snapshot => {
      const users = [];
      snapshot.forEach(child => {
        const data = child.val();
        if (data.online) users.push(data);
      });
      updateUserList(users);
    });

    setInterval(() => {
      if (userRef) {
        userRef.update({ lastActive: Date.now() });
      }
    }, 10000);

    function updateUserList(users) {
      userList.innerHTML = '';
      activeUserCount.textContent = users.length;
      users.forEach(user => {
        const el = document.createElement('div');
        el.className = 'flex items-center space-x-1 p-1 bg-gray-900 rounded';
        el.innerHTML = `
          <div class="w-2 h-2 rounded-full" style="background-color:${user.color}"></div>
          <span>${user.nickname}</span>
          ${user.typing ? '<span class="text-xs text-green-400">(typing...)</span>' : ''}
        `;
        userList.appendChild(el);
      });
    }

    function generateId() {
      return Math.random().toString(36).substring(2, 9);
    }

    function getRandomColor() {
      const colors = ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function formatTime(ms) {
      const d = new Date(ms);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
  </script>
</body>
</html>

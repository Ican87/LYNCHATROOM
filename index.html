<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LYN CHAT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #e8f5e9;
            color: #2d5a27;
            overflow-x: hidden;
            background-image: url('https://www.transparenttextures.com/patterns/leaves.png'), linear-gradient(to bottom, #a5d6a7, #e8f5e9);
            background-blend-mode: overlay;
        }
        .logo-container {
            border: 1px solid #4a7c59;
            box-shadow: 0 0 10px #4a7c59, 
                        inset 0 0 10px #4a7c59;
            animation: borderAnimation 20s linear infinite;
        }
        
        .garden-font {
            font-family: 'Orbitron', sans-serif;
            color: #2d5a27;
        }
        
        .garden-box {
            border: 1px solid #4a7c59;
            box-shadow: 0 0 10px #4a7c59, 
                        inset 0 0 10px #4a7c59;
            position: relative;
            overflow: hidden;
        }
        
        .cyberpunk-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00ff41, #008f11, #003b00, #00ff41);
            background-size: 400%;
            z-index: -1;
            animation: borderAnimation 20s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes borderAnimation {
            0% {
                background-position: 0 0;
            }
            50% {
                background-position: 400% 0;
            }
            100% {
                background-position: 0 0;
            }
        }
        
        .cyberpunk-input {
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 10px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .cyberpunk-input:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff41;
        }
        
        .garden-btn {
            background: linear-gradient(45deg, #4a7c59, #8ba888);
            color: #f0f7f0;
            border: 1px solid #4a7c59;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        
        .cyberpunk-btn:hover {
            background: linear-gradient(45deg, #008f11, #00ff41);
            box-shadow: 0 0 15px #00ff41;
            transform: translateY(-2px);
        }
        
        .cyberpunk-btn:active {
            transform: translateY(0);
        }
        
        .garden-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        
        .garden-scrollbar::-webkit-scrollbar-track {
            background: rgba(74, 124, 89, 0.1);
        }
        
        .garden-scrollbar::-webkit-scrollbar-thumb {
            background: #4a7c59;
            border-radius: 5px;
        }
        
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(0, 255, 65, 0.1) 0%,
                rgba(0, 255, 65, 0) 10%
            );
            background-size: 100% 8px;
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes scanline {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 0 100%;
            }
        }
        
        .glitch {
            position: relative;
        }
        
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
        }
        
        .glitch::before {
            color: #0ff;
            z-index: -1;
            animation: glitch-effect 3s infinite;
        }
        
        .glitch::after {
            color: #f0f;
            z-index: -2;
            animation: glitch-effect 2s infinite reverse;
        }
        
        @keyframes glitch-effect {
            0% {
                transform: translate(0);
            }
            20% {
                transform: translate(-3px, 3px);
            }
            40% {
                transform: translate(-3px, -3px);
            }
            60% {
                transform: translate(3px, 3px);
            }
            80% {
                transform: translate(3px, -3px);
            }
            100% {
                transform: translate(0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        .vines-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .vine-left {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 50px;
            background-image: url('https://www.transparenttextures.com/patterns/bright-squares.png');
            opacity: 0.2;
            mask-image: linear-gradient(to right, black 0%, transparent 100%);
        }

        .vine-right {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 50px;
            background-image: url('https://www.transparenttextures.com/patterns/bright-squares.png');
            opacity: 0.2;
            mask-image: linear-gradient(to left, black 0%, transparent 100%);
            transform: scaleX(-1);
        }

        .floral-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: url('https://www.transparenttextures.com/patterns/flowers.png');
            background-size: 300px;
            opacity: 0.1;
        }

        .flower {
            position: absolute;
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            animation: float 8s infinite ease-in-out;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }

        .flower-1 {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23f06292" opacity="0.8"/><circle cx="30" cy="30" r="15" fill="%23fff" opacity="0.9"/><circle cx="70" cy="30" r="15" fill="%23fff" opacity="0.9"/><circle cx="30" cy="70" r="15" fill="%23fff" opacity="0.9"/><circle cx="70" cy="70" r="15" fill="%23fff" opacity="0.9"/></svg>');
        }

        .flower-2 {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="35" fill="%23ffd54f" opacity="0.8"/><path d="M50,15 Q60,40 50,65 Q40,40 50,15" fill="%23fff" opacity="0.9" transform="rotate(0 50 50)"/><path d="M50,15 Q60,40 50,65 Q40,40 50,15" fill="%23fff" opacity="0.9" transform="rotate(72 50 50)"/><path d="M50,15 Q60,40 50,65 Q40,40 50,15" fill="%23fff" opacity="0.9" transform="rotate(144 50 50)"/><path d="M50,15 Q60,40 50,65 Q40,40 50,15" fill="%23fff" opacity="0.9" transform="rotate(216 50 50)"/><path d="M50,15 Q60,40 50,65 Q40,40 50,15" fill="%23fff" opacity="0.9" transform="rotate(288 50 50)"/></svg>');
        }

        .flower-3 {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="%234caf50" opacity="0.8"/><circle cx="50" cy="50" r="15" fill="%23ffeb3b" opacity="0.9"/></svg>');
        }

        .leaf {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20,50 Q50,10 80,50 Q50,90 20,50" fill="%234a7c59" opacity="0.4"/></svg>');
            background-size: contain;
            animation: sway 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .terminal-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #00ff41;
            animation: blink 1s step-end infinite;
        }
        
        @keyframes blink {
            from, to {
                background-color: transparent;
            }
            50% {
                background-color: #00ff41;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="scanline"></div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="garden-box w-full max-w-md p-8 rounded-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-white opacity-90"></div>
        <div class="vines-decoration">
            <div class="vine-left"></div>
            <div class="vine-right"></div>
        </div>
        <div class="floral-decoration">
            <div class="flower flower-1" style="top: 10%; left: 5%; animation-delay: 0s;"></div>
            <div class="flower flower-2" style="top: 20%; right: 8%; animation-delay: 2s; width: 50px; height: 50px;"></div>
            <div class="flower flower-3" style="bottom: 15%; left: 10%; animation-delay: 4s;"></div>
            <div class="flower flower-1" style="bottom: 25%; right: 5%; animation-delay: 6s; transform: rotate(45deg);"></div>
            <div class="leaf" style="top: 15%; left: 3%; transform: rotate(30deg);"></div>
            <div class="leaf" style="top: 30%; right: 2%; transform: rotate(-20deg); animation-delay: 3s;"></div>
            <div class="leaf" style="bottom: 20%; left: 2%; transform: rotate(-15deg); animation-delay: 5s;"></div>
            <div class="leaf" style="bottom: 35%; right: 4%; transform: rotate(25deg); animation-delay: 7s;"></div>
        </div>
        <div class="relative z-10">
            <h1 class="garden-font text-3xl md:text-4xl text-center mb-6">LYNCHAT 2.0</h1>
            
            <div class="mb-6">
                <label for="nickname" class="block text-sm mb-2">ENTER YOUR NICKNAME</label>
                <input type="text" id="nickname" class="w-full p-3 rounded border border-green-500 bg-white bg-opacity-70 focus:outline-none focus:ring-2 focus:ring-green-300" placeholder="GARDENER_01">
            </div>
            
            <div class="mb-6">
                <label class="block text-sm mb-2">FOLLOW OUR INSTAGRAM</label>
                <div class="flex items-center cyberpunk-box p-3">
                    <i class="fab fa-instagram text-xl mr-3 text-purple-400"></i>
                    <span class="flex-1">@exvisuites</span>
                    <button id="verifyBtn" class="garden-btn px-3 py-1 rounded text-xs">
                        VERIFY
                    </button>
                </div>
                <div id="followStatus" class="text-xs mt-2 hidden">
                    <i class="fas fa-check-circle text-green-400 mr-1"></i>
                    <span>FOLLOW VERIFIED</span>
                </div>
            </div>
            
            <button id="joinBtn" disabled class="garden-btn w-full py-3 rounded-lg flex items-center justify-center opacity-50 cursor-not-allowed">
                <span>ACCESS DENIED</span>
                <i class="fas fa-lock ml-2"></i>
            </button>
            
            <div class="mt-6 text-xs text-center text-green-700">
                <p>WARNING: UNAUTHORIZED ACCESS WILL BE TRACED</p>
                <p class="mt-1">ALL ACTIVITIES ARE LOGGED</p>
            </div>
        </div>
    </div>
    
    <!-- Chat Room -->
    <div id="chatRoom" class="hidden w-full max-w-4xl h-[70vh] garden-box rounded-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-white opacity-90"></div>
        <div class="vines-decoration">
            <div class="vine-left"></div>
            <div class="vine-right"></div>
        </div>
        <div class="floral-decoration">
            <div class="flower flower-1" style="top: 10%; left: 5%;"></div>
            <div class="flower flower-2" style="top: 20%; right: 8%; animation-delay: 2s; width: 50px; height: 50px;"></div>
            <div class="flower flower-3" style="bottom: 15%; left: 7%; animation-delay: 4s;"></div>
            <div class="flower flower-1" style="bottom: 25%; right: 5%; animation-delay: 6s; transform: rotate(45deg);"></div>
            <div class="flower flower-2" style="top: 40%; left: 15%; animation-delay: 1s; width: 35px; height: 35px;"></div>
            <div class="flower flower-3" style="top: 60%; right: 15%; animation-delay: 3s;"></div>
            <div class="leaf" style="top: 15%; left: 3%; transform: rotate(30deg);"></div>
            <div class="leaf" style="top: 30%; right: 2%; transform: rotate(-20deg); animation-delay: 3s;"></div>
            <div class="leaf" style="bottom: 20%; left: 2%; transform: rotate(-15deg); animation-delay: 5s;"></div>
            <div class="leaf" style="bottom: 35%; right: 4%; transform: rotate(25deg); animation-delay: 7s;"></div>
        </div>
        <div class="relative z-10 h-full flex flex-col">
            <!-- Header -->
            <div class="border-b border-green-500 p-3 md:p-4 flex justify-between items-center">
                <div>
                    <h2 class="cyberpunk-font text-lg md:text-xl">LYNCHAT</h2>
                    <div class="flex items-center text-[10px] md:text-xs">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse"></div>
                        <span id="connectionStatus">CONNECTING...</span>
                    </div>
                </div>
                <div class="text-xs md:text-sm">
                    <span id="userCount">0</span> USERS
                </div>
                <div class="text-xs md:text-sm">
                    <span id="currentUser" class="text-green-400">GUEST</span>
                </div>
                <button id="startStreamBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm mr-2">
                    <i class="fas fa-video mr-1"></i> <span class="hidden md:inline">STREAM</span>
                </button>
                <button id="clearChatBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm mr-2">
                    <i class="fas fa-trash mr-1"></i> <span class="hidden md:inline">CLEAR</span>
                </button>
                <button id="closeChatBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm">
                    <i class="fas fa-times mr-1"></i> <span class="hidden md:inline">CLOSE</span>
                </button>
            </div>
            
            <!-- Stream Container -->
            <div id="streamContainer" class="hidden p-4 border-b border-green-500">
                <div class="cyberpunk-box p-2">
                    <video id="localStreamVideo" class="w-full" autoplay playsinline muted></video>
                    <div id="remoteStreams" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div class="flex justify-between mt-2">
                        <div class="text-xs text-green-400">
                            <span id="streamStatus">LIVE STREAM</span>
                        </div>
                        <button id="stopStreamBtn" class="cyberpunk-btn px-2 py-1 rounded text-xs">
                            <i class="fas fa-stop mr-1"></i> STOP
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 cyberpunk-scrollbar space-y-4">
                <div class="text-center text-green-700 text-sm">
                    <p>🌿 SYSTEM: WELCOME TO THE SECRET GARDEN CHAT  🌿</p>
                    <p>YOUR WORDS WILL BLOOM LIKE SPRING FLOWERS</p>
                    <p class="mt-2">🌸 🌼 🌻 🌺 🌹 🌷 🌸</p>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="border-t border-green-500 p-4">
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" class="cyberpunk-input flex-1 rounded" placeholder="TYPE YOUR MESSAGE..." disabled>
                    <button id="sendBtn" class="cyberpunk-btn px-4 rounded flex items-center justify-center" disabled>
                        <i class="fas fa-paper-plane mr-2"></i>
                        <span>SEND</span>
                    </button>
                </div>
                <div class="flex justify-between mt-2 text-[10px] md:text-xs text-gray-500">
                    <div>
                        <span id="typingIndicator"></span>
                    </div>
                    <div>
                        <span id="characterCount">0/200</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7zwrxJVZPxEfM9ulVOUJOSCnMjb1kyk0",
  authDomain: "lynchat-f6fbc.firebaseapp.com",
  databaseURL: "https://lynchat-f6fbc-default-rtdb.firebaseio.com",
  projectId: "lynchat-f6fbc",
  storageBucket: "lynchat-f6fbc.appspot.com",
  messagingSenderId: "465251710149",
  appId: "1:465251710149:web:e6243a6ca5de6754c1ecac",
  measurementId: "G-LGDFQ5JK6G"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // DOM Elements
        const clearChatBtn = document.getElementById('clearChatBtn');
        const loginScreen = document.getElementById('loginScreen');
        const startStreamBtn = document.getElementById('startStreamBtn');
        const stopStreamBtn = document.getElementById('stopStreamBtn');
        const streamContainer = document.getElementById('streamContainer');
        const streamVideo = document.getElementById('streamVideo');
        const streamStatus = document.getElementById('streamStatus');
        let mediaStream = null;
        const chatRoom = document.getElementById('chatRoom');
        const nicknameInput = document.getElementById('nickname');
        const verifyBtn = document.getElementById('verifyBtn');
        const followStatus = document.getElementById('followStatus');
        const joinBtn = document.getElementById('joinBtn');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const currentUser = document.getElementById('currentUser');
        const userCount = document.getElementById('userCount');
        const connectionStatus = document.getElementById('connectionStatus');
        const typingIndicator = document.getElementById('typingIndicator');
        const characterCount = document.getElementById('characterCount');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const retryBtn = document.getElementById('retryBtn');
        
        // State
        let username = '';
        let isFollowing = false;
        let socket;
        let typingTimeout;
        let peerConnections = {};
        let localStream = null;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // Instagram follow verification
        verifyBtn.addEventListener('click', () => {
            // Open Instagram in new tab
            window.open('https://www.instagram.com/exvisuites/', '_blank');
            
            // Show verification UI
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> VERIFYING...';
            
            // Simulate verification delay
            setTimeout(() => {
                isFollowing = true;
                followStatus.classList.remove('hidden');
                verifyBtn.classList.add('hidden');
                
                // Enable join button if nickname is filled
                if (nicknameInput.value.trim()) {
                    joinBtn.disabled = false;
                    joinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    joinBtn.innerHTML = '<span>ACCESS GRANTED</span> <i class="fas fa-unlock ml-2"></i>';
                }
            }, 2000);
        });
        
        // Enable join button when nickname is entered and following
        nicknameInput.addEventListener('input', () => {
            if (nicknameInput.value.trim() && isFollowing) {
                joinBtn.disabled = false;
                joinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                joinBtn.innerHTML = '<span>ACCESS GRANTED</span> <i class="fas fa-unlock ml-2"></i>';
            } else {
                joinBtn.disabled = true;
                joinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                joinBtn.innerHTML = '<span>ACCESS DENIED</span> <i class="fas fa-lock ml-2"></i>';
            }
        });
        
        // Join chat room
        joinBtn.addEventListener('click', () => {
            username = nicknameInput.value.trim() || 'ANONYMOUS_' + Math.floor(Math.random() * 1000);
            currentUser.textContent = username;
            
            loginScreen.classList.add('hidden');
            chatRoom.classList.remove('hidden');
            
            // Connect to Firebase
            connectToChat();
            
            // Listen for new messages
            const messagesRef = database.ref('messages');
            messagesRef.orderByChild('timestamp').limitToLast(100).on('child_added', (snapshot) => {
                const message = snapshot.val();
                addMessage(message.sender, message.text, message.sender === username);
            });
            
            // Update user count
            const usersRef = database.ref('users/' + username);
            usersRef.set(true);
            usersRef.onDisconnect().remove();
            
            const userCountRef = database.ref('users');
            userCountRef.on('value', (snapshot) => {
                const count = snapshot.numChildren();
                userCount.textContent = count;
            });
        });
        
        // Connect to Firebase
        function connectToChat() {
            connectionStatus.textContent = 'CONNECTING...';
            
            // Check Firebase connection
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    connectionStatus.textContent = 'CONNECTED';
                    connectionStatus.classList.remove('text-yellow-500');
                    connectionStatus.classList.add('text-green-500');
                    
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    
                    // Add welcome message
                    addSystemMessage(`@${username}, YOU'RE NOW CONNECTED TO LYNCHAT`);
                } else {
                    connectionStatus.textContent = 'CONNECTION FAILED';
                    connectionStatus.classList.remove('text-green-500');
                    connectionStatus.classList.add('text-red-500');
                }
            });
        }
        
        // Send message
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Typing indicator
        messageInput.addEventListener('input', () => {
            characterCount.textContent = `${messageInput.value.length}/200`;
            
            // Show typing indicator briefly
            typingIndicator.textContent = 'YOU ARE TYPING...';
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                typingIndicator.textContent = '';
            }, 2000);
        });
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && message.length <= 200) {
                // Save message to Firebase
                const messagesRef = database.ref('messages');
                const newMessageRef = messagesRef.push();
                newMessageRef.set({
                    sender: username,
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                messageInput.value = '';
                characterCount.textContent = '0/200';
            }
        }
        
        // Add message to chat
        function addMessage(sender, text, isCurrentUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs md:max-w-md rounded-lg px-4 py-2 ${isCurrentUser ? 'bg-green-900 bg-opacity-50' : 'bg-gray-900 bg-opacity-50'} transition-all duration-300 transform hover:scale-105`;
            
            const senderSpan = document.createElement('span');
            senderSpan.className = 'text-lg font-bold text-white';
            senderSpan.textContent = `@${sender} `;
            
            const textDiv = document.createElement('span');
            textDiv.className = 'text-lg';
            textDiv.textContent = text;
            
            bubble.appendChild(senderSpan);
            bubble.appendChild(textDiv);
            messageDiv.appendChild(bubble);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Add system message
        function addSystemMessage(text) {
            const systemDiv = document.createElement('div');
            systemDiv.className = 'text-center text-base text-gray-500 my-2';
            systemDiv.textContent = `SYSTEM: ${text}`;
            messagesContainer.appendChild(systemDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        
        // Clear chat history
        clearChatBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all chat history?')) {
                database.ref('messages').remove()
                    .then(() => {
                        messagesContainer.innerHTML = `
                            <div class="text-center text-gray-500 text-sm">
                                <p>SYSTEM: CHAT HISTORY CLEARED</p>
                                <p>YOUR MESSAGES ARE END-TO-END ENCRYPTED</p>
                            </div>
                        `;
                        addSystemMessage(`@${username} CLEARED THE CHAT HISTORY`);
                    })
                    .catch((error) => {
                        addSystemMessage(`ERROR: ${error.message}`);
                    });
            }
        });
        // Handle streaming
        startStreamBtn.addEventListener('click', async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localStreamVideo').srcObject = localStream;
                streamContainer.classList.remove('hidden');
                startStreamBtn.classList.add('hidden');
                addSystemMessage(`@${username} STARTED A LIVE STREAM`);
                
                // Create peer connection for each existing user
                database.ref('users').once('value').then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        if (userSnapshot.key !== username) {
                            createPeerConnection(userSnapshot.key);
                        }
                    });
                });
                
                // Listen for new users to create peer connections
                database.ref('users').on('child_added', userSnapshot => {
                    if (userSnapshot.key !== username && !peerConnections[userSnapshot.key]) {
                        createPeerConnection(userSnapshot.key);
                    }
                });
                
            } catch (err) {
                addSystemMessage(`STREAM ERROR: ${err.message}`);
            }
        });
        
        stopStreamBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                document.getElementById('localStreamVideo').srcObject = null;
                
                // Close all peer connections
                Object.keys(peerConnections).forEach(userId => {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                });
                
                // Clear remote streams
                document.getElementById('remoteStreams').innerHTML = '';
                
                streamContainer.classList.add('hidden');
                startStreamBtn.classList.remove('hidden');
                addSystemMessage(`@${username} ENDED THE STREAM`);
            }
        });
        
        function createPeerConnection(userId) {
            const peerConnection = new RTCPeerConnection(configuration);
            peerConnections[userId] = peerConnection;
            
            // Add local stream tracks
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Listen for ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    database.ref(`signaling/${username}/${userId}/candidates`).push({
                        candidate: event.candidate
                    });
                }
            };
            
            // Listen for remote stream
            peerConnection.ontrack = event => {
                const remoteStreamsDiv = document.getElementById('remoteStreams');
                const existingVideo = document.getElementById(`remoteVideo_${userId}`);
                
                if (!existingVideo) {
                    const video = document.createElement('video');
                    video.id = `remoteVideo_${userId}`;
                    video.className = 'w-full';
                    video.autoplay = true;
                    video.playsInline = true;
                    
                    const userDiv = document.createElement('div');
                    userDiv.className = 'cyberpunk-box p-2';
                    userDiv.innerHTML = `<div class="text-xs text-green-400 mb-1">@${userId}</div>`;
                    userDiv.appendChild(video);
                    
                    remoteStreamsDiv.appendChild(userDiv);
                    video.srcObject = event.streams[0];
                }
            };
            
            // Create offer
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    database.ref(`signaling/${username}/${userId}/offer`).set({
                        sdp: peerConnection.localDescription
                    });
                });
            
            // Listen for answer
            database.ref(`signaling/${userId}/${username}/answer`).on('value', snapshot => {
                const data = snapshot.val();
                if (data && peerConnection.remoteDescription === null) {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                }
            });
            
            // Listen for ICE candidates from remote
            database.ref(`signaling/${userId}/${username}/candidates`).on('child_added', snapshot => {
                const data = snapshot.val();
                if (data) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            });
        }
        
        // Listen for incoming streams
        database.ref('users').on('child_added', userSnapshot => {
            if (userSnapshot.key !== username) {
                database.ref(`signaling/${userSnapshot.key}/${username}/offer`).on('value', snapshot => {
                    const data = snapshot.val();
                    if (data && !peerConnections[userSnapshot.key]) {
                        const peerConnection = new RTCPeerConnection(configuration);
                        peerConnections[userSnapshot.key] = peerConnection;
                        
                        peerConnection.onicecandidate = event => {
                            if (event.candidate) {
                                database.ref(`signaling/${username}/${userSnapshot.key}/candidates`).push({
                                    candidate: event.candidate
                                });
                            }
                        };
                        
                        peerConnection.ontrack = event => {
                            const remoteStreamsDiv = document.getElementById('remoteStreams');
                            const existingVideo = document.getElementById(`remoteVideo_${userSnapshot.key}`);
                            
                            if (!existingVideo) {
                                const video = document.createElement('video');
                                video.id = `remoteVideo_${userSnapshot.key}`;
                                video.className = 'w-full';
                                video.autoplay = true;
                                video.playsInline = true;
                                
                                const userDiv = document.createElement('div');
                                userDiv.className = 'cyberpunk-box p-2';
                                userDiv.innerHTML = `<div class="text-xs text-green-400 mb-1">@${userSnapshot.key}</div>`;
                                userDiv.appendChild(video);
                                
                                remoteStreamsDiv.appendChild(userDiv);
                                video.srcObject = event.streams[0];
                            }
                        };
                        
                        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
                            .then(() => peerConnection.createAnswer())
                            .then(answer => peerConnection.setLocalDescription(answer))
                            .then(() => {
                                database.ref(`signaling/${username}/${userSnapshot.key}/answer`).set({
                                    sdp: peerConnection.localDescription
                                });
                            });
                    }
                });
            }
        });
        // Close chat and return to login
        document.getElementById('closeChatBtn').addEventListener('click', () => {
            // Stop any active stream when closing chat
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                document.getElementById('localStreamVideo').srcObject = null;
                
                // Close all peer connections
                Object.keys(peerConnections).forEach(userId => {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                });
                
                // Clear remote streams
                document.getElementById('remoteStreams').innerHTML = '';
            }
            
            // Remove Firebase listeners
            database.ref('messages').off();
            database.ref('users/' + username).remove();
            database.ref('users').off();
            
            chatRoom.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            // Reset chat state
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 text-sm">
                    <p>SYSTEM: WELCOME TO CYBERCHAT 2077</p>
                    <p>YOUR MESSAGES ARE END-TO-END ENCRYPTED</p>
                </div>
            `;
            messageInput.value = '';
            characterCount.textContent = '0/200';
        });
        // Terminal-like blinking cursor effect
        const cursor = document.createElement('span');
        cursor.className = 'terminal-cursor';
        document.body.appendChild(cursor);
        
        // Random glitch effect occasionally
        setInterval(() => {
            if (Math.random() > 0.9) {
                document.body.classList.add('glitch-effect');
                setTimeout(() => {
                    document.body.classList.remove('glitch-effect');
                }, 200);
            }
        }, 10000);
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=ican69/lynchat" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>
